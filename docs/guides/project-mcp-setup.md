# Создание проектных MCP-серверов

## Что такое проектные MCP?

Для каждого проекта 1С можно создать 2 специализированных MCP-сервера, которые индексируют вашу конфигурацию и предоставляют:

1. **Metadata & Code Search MCP** — семантический поиск по метаданным и коду
2. **Graph MCP** — граф зависимостей объектов конфигурации (Neo4j)

## Зачем это нужно?

### Без проектных MCP

```
Пользователь: Где используется справочник Контрагенты?

AI: Нужно искать вручную через grep/glob...
```

### С проектными MCP

```
Пользователь: Где используется справочник Контрагенты?

AI (использует PROJECT-graph-cypher):
Справочник Контрагенты используется в:
- Документ.ЗаказКлиента (реквизит Контрагент)
- Документ.РеализацияТоваров (реквизит Покупатель)
- Отчет.АнализПродаж (параметр Контрагент)
- 15 других мест...
```

## Архитектура

```
┌─────────────────────────────────────────┐
│ 1C Configuration (XML)                  │
└────────────┬────────────────────────────┘
             │
             ├──> Indexer (Python/Node.js)
             │
             ├──> Vector DB (embeddings)
             │    - Metadata search
             │    - Code search
             │    - Documentation search
             │
             └──> Neo4j (graph)
                  - Object relationships
                  - Dependencies
                  - Call graph
```

## Способы индексации

### Вариант 1: Облачная индексация (быстро)

**Преимущества:**
- Быстрая индексация (минуты)
- Высокое качество embeddings (OpenAI, Anthropic)
- Не требует мощного железа

**Недостатки:**
- Требует API ключ (платно)
- Отправка кода в облако (вопросы безопасности)

**Стоимость:**
- OpenAI embeddings: ~$0.10 за 1M токенов
- Типичная конфигурация (~100k строк кода): ~$1-2 на индексацию
- Переиндексация при изменениях: ~$0.10-0.50

**Настройка:**

```bash
# Установите индексатор
git clone https://github.com/yourusername/1c-mcp-indexer.git
cd 1c-mcp-indexer

# Настройте API ключ
export OPENAI_API_KEY="sk-..."

# Запустите индексацию
python indexer.py \
  --config /path/to/your-project/src/cf \
  --output ./index \
  --provider openai
```

### Вариант 2: Локальная индексация (бесплатно)

**Преимущества:**
- Бесплатно
- Данные не покидают вашу сеть
- Полный контроль

**Недостатки:**
- Медленнее (часы для большой конфигурации)
- Требует GPU (рекомендуется) или мощный CPU
- Качество embeddings ниже, чем у OpenAI

**Требования:**
- GPU: NVIDIA с 8GB+ VRAM (рекомендуется)
- CPU: 16GB+ RAM (если без GPU)
- Диск: 10GB+ свободного места

**Модель:** Qwen 3 8B (оптимальное соотношение качество/скорость)

**Настройка:**

```bash
# Установите индексатор
git clone https://github.com/yourusername/1c-mcp-indexer.git
cd 1c-mcp-indexer

# Установите зависимости
pip install -r requirements.txt

# Скачайте модель Qwen 3 8B
python download_model.py --model qwen3-8b

# Запустите индексацию
python indexer.py \
  --config /path/to/your-project/src/cf \
  --output ./index \
  --provider local \
  --model qwen3-8b
```

**Время индексации (примерно):**
- Малая конфигурация (<10k строк): 10-30 минут
- Средняя конфигурация (10-50k строк): 1-3 часа
- Большая конфигурация (50-200k строк): 3-8 часов
- Очень большая (>200k строк): 8-24 часа

## Создание MCP-серверов

### Metadata & Code Search MCP

**Шаг 1: Индексация**

```bash
# После индексации у вас будет папка ./index с:
# - metadata.db (SQLite с метаданными)
# - code.db (SQLite с кодом)
# - embeddings/ (векторные представления)
```

**Шаг 2: Запуск MCP-сервера**

```bash
# Запустите сервер
python mcp-server.py \
  --index ./index \
  --port 7500 \
  --name PROJECT-codemetadata

# Сервер будет доступен на http://localhost:7500/mcp
```

**Шаг 3: Настройка в Cursor**

Добавьте в `.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "PROJECT-codemetadata": {
      "command": "curl",
      "args": [
        "-X", "POST",
        "http://localhost:7500/mcp",
        "-H", "Content-Type: application/json",
        "-d", "@-"
      ]
    }
  }
}
```

### Graph MCP (Neo4j)

**Шаг 1: Установка Neo4j**

```bash
# Docker (рекомендуется)
docker run -d \
  --name neo4j-project \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password \
  neo4j:latest
```

**Шаг 2: Построение графа**

```bash
# Запустите построение графа
python build-graph.py \
  --config /path/to/your-project/src/cf \
  --neo4j bolt://localhost:7687 \
  --user neo4j \
  --password password
```

**Граф будет содержать:**
- Узлы: Справочники, Документы, Отчеты, Обработки, Модули и т.д.
- Связи: Реквизиты, Табличные части, Использование, Вызовы функций

**Шаг 3: Запуск MCP-сервера**

```bash
# Запустите сервер
python mcp-graph-server.py \
  --neo4j bolt://localhost:7687 \
  --user neo4j \
  --password password \
  --port 7501 \
  --name PROJECT-graph

# Сервер будет доступен на http://localhost:7501/mcp
```

**Шаг 4: Настройка в Cursor**

Добавьте в `.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "PROJECT-graph": {
      "command": "curl",
      "args": [
        "-X", "POST",
        "http://localhost:7501/mcp",
        "-H", "Content-Type: application/json",
        "-d", "@-"
      ]
    }
  }
}
```

## Использование

### Поиск по метаданным

```
Пользователь: Какие реквизиты у справочника Номенклатура?

AI (использует PROJECT-codemetadata-metadatasearch):
Справочник.Номенклатура имеет реквизиты:
- Артикул (Строка, 50)
- Наименование (Строка, 150)
- ЕдиницаИзмерения (СправочникСсылка.ЕдиницыИзмерения)
- Цена (Число, 15.2)
- ...
```

### Поиск по коду

```
Пользователь: Где реализована функция РассчитатьСумму?

AI (использует PROJECT-codemetadata-codesearch):
Функция РассчитатьСумму найдена в:
1. ОбщийМодуль.РаботаСДокументами.РассчитатьСумму()
2. Документ.ЗаказКлиента.МодульОбъекта.РассчитатьСумму()
3. ...
```

### Граф зависимостей

```
Пользователь: Что зависит от справочника Контрагенты?

AI (использует PROJECT-graph-cypher):
MATCH (c:Catalog {name: "Контрагенты"})<-[:USES]-(d)
RETURN d

Результат:
- Документ.ЗаказКлиента
- Документ.РеализацияТоваров
- Отчет.АнализПродаж
- ...
```

## Обновление индекса

### При изменении конфигурации

```bash
# Переиндексируйте только измененные объекты
python indexer.py \
  --config /path/to/your-project/src/cf \
  --output ./index \
  --incremental \
  --changed-since "2024-02-10"
```

### Автоматическое обновление

Настройте Git hook для автоматической переиндексации:

```bash
# .git/hooks/post-commit
#!/bin/bash

# Проверяем, изменились ли файлы конфигурации
if git diff-tree --no-commit-id --name-only -r HEAD | grep -q "src/cf/"; then
  echo "Configuration changed, reindexing..."
  python /path/to/indexer.py \
    --config ./src/cf \
    --output ./index \
    --incremental
fi
```

## Стоимость и производительность

### Облачная индексация

| Размер конфигурации | Время | Стоимость (OpenAI) |
|---------------------|-------|-------------------|
| Малая (<10k строк) | 1-2 мин | $0.10-0.20 |
| Средняя (10-50k) | 5-10 мин | $0.50-1.00 |
| Большая (50-200k) | 15-30 мин | $1.00-2.00 |
| Очень большая (>200k) | 30-60 мин | $2.00-5.00 |

### Локальная индексация (Qwen 3 8B)

| Размер конфигурации | Время (GPU) | Время (CPU) |
|---------------------|-------------|-------------|
| Малая (<10k строк) | 10-30 мин | 30-60 мин |
| Средняя (10-50k) | 1-3 часа | 3-6 часов |
| Большая (50-200k) | 3-8 часов | 8-24 часа |
| Очень большая (>200k) | 8-24 часа | 24-72 часа |

## Решение проблем

### Индексация зависла

**Проблема:** Процесс индексации не завершается

**Решение:**
1. Проверьте логи: `tail -f indexer.log`
2. Проверьте память: `free -h` (Linux) или Task Manager (Windows)
3. Уменьшите batch size: `--batch-size 10`
4. Используйте incremental mode: `--incremental`

### Neo4j не запускается

**Проблема:** Ошибка "Neo4j failed to start"

**Решение:**
1. Проверьте порты: `netstat -an | grep 7687`
2. Проверьте логи: `docker logs neo4j-project`
3. Увеличьте память: `-e NEO4J_dbms_memory_heap_max__size=4G`

### MCP-сервер не отвечает

**Проблема:** Ошибка "MCP server timeout"

**Решение:**
1. Проверьте, что сервер запущен: `curl http://localhost:7500/health`
2. Проверьте логи сервера
3. Увеличьте timeout в `.cursor/mcp.json`

## Следующие шаги

- [Использование агентов с проектными MCP](agents.md)
- [Оптимизация запросов к MCP](mcp-optimization.md)
- [Создание собственных MCP-инструментов](custom-mcp.md)
