# Specification-Driven Development (SDD) Workflow

Workflow для разработки доработок в 1С с использованием спецификаций.

**Приоритет**: 180 (высокий)  
**Применяется**: При разработке доработок 1С

---

## OVERVIEW

SDD (Specification-Driven Development) — это подход к разработке, где спецификация создаётся и ревьюится ДО написания кода.

**Преимущества**:
- ✅ Экономия времени (ошибки в плане дешевле ошибок в коде)
- ✅ Чёткое понимание требований
- ✅ Адаптивный подход (1-4+ агентов в зависимости от сложности)
- ✅ Атомарные этапы с критериями приемки
- ✅ Итеративное ревью до качества

---

## WORKFLOW (9 ФАЗА)

### Phase 0: Оценка сложности

**Цель**: Понять масштаб задачи и выбрать стратегию

**Действия**:
```yaml
1. Создать структуру:
   mkdir -p openspec/changes/[feature-name]
   touch openspec/changes/[feature-name]/phase0-complexity.md

2. Оценить сложность:
   - Простая: Небольшое изменение, очевидная реализация
   - Средняя: Несколько модулей, требует понимания архитектуры
   - Сложная: Большая доработка, несколько подсистем
   - Критичная: Архитектурные изменения, высокие риски

3. Выбрать стратегию:
   - Простая: 1 агент explorer, 1 агент architect, 1 агент writer
   - Средняя: 1-2 агента explorer, 1-2 агента architect, 1 агент writer
   - Сложная: 2-4 агента explorer, 2-3 агента architect (мультисэмплинг), 1 агент writer
   - Критичная: 4+ агентов explorer, 3 агента architect (разные подходы), 1 агент writer

4. Сохранить оценку:
   openspec/changes/[feature-name]/phase0-complexity.md:
     - Оценка сложности
     - Обоснование
     - Выбранная стратегия
     - Ожидаемое количество агентов
```

**Артефакт**: `openspec/changes/[feature-name]/phase0-complexity.md`

---

### Phase 1: Discovery (Уточнение требований)

**Цель**: Понять, что нужно построить

**Действия**:
```yaml
1. Если доработка неясна:
   - Задать вопросы пользователю:
     * Какую проблему решаем?
     * Что должна делать доработка?
     * Есть ли ограничения?
     * Есть ли требования к производительности?

2. Резюмировать понимание:
   - Кратко описать задачу
   - Перечислить ключевые требования
   - Указать ограничения

3. Получить подтверждение от пользователя

4. Сохранить в openspec/:
   openspec/changes/[feature-name]/phase1-requirements.md:
     - Исходный запрос
     - Уточняющие вопросы и ответы
     - Резюме понимания
     - Ключевые требования
     - Ограничения
     - Подтверждение пользователя
```

**Артефакт**: `openspec/changes/[feature-name]/phase1-requirements.md`

---

### Phase 2: Исследование кодовой базы

**Цель**: Понять существующий код и паттерны

**Адаптивный подход** (количество агентов зависит от сложности):

```yaml
Простая задача (1 агент):
  - Запустить 1 агента onec-code-explorer
  - Фокус: Похожие доработки, основные паттерны

Средняя задача (1-2 агента):
  - Запустить 1-2 агента onec-code-explorer
  - Фокус: Архитектура, паттерны, интеграции
  - Возможно последовательно (углубление)

Сложная задача (2-4 агента):
  - Запустить 2-4 агента onec-code-explorer
  - Фокус: Разные аспекты (архитектура, данные, интеграции, производительность)
  - Параллельно или последовательно (углубление)

Критичная задача (4+ агентов):
  - Запустить 4+ агентов onec-code-explorer
  - Фокус: Полный анализ всех аспектов
  - Итеративное углубление
```

**Действия**:
```yaml
1. Принять решение о стратегии:
   - Сколько агентов?
   - Параллельно или последовательно?
   - Какие аспекты исследовать?

2. Запустить агентов onec-code-explorer:
   - Передать путь к requirements
   - Указать фокус исследования
   - Запросить список ключевых файлов

3. Прочитать ключевые файлы:
   - Все файлы, указанные агентами
   - Для глубокого понимания

4. Оценить достаточность:
   - Достаточно ли понимания?
   - Нужно ли углубление?
   - Запустить ещё агентов если нужно

5. Сохранить сводку:
   openspec/changes/[feature-name]/phase2-exploration.md:
     - Найденные паттерны
     - Похожие доработки
     - Ключевые компоненты
     - Архитектурные инсайты
     - Список прочитанных файлов
```

**Артефакт**: `openspec/changes/[feature-name]/phase2-exploration.md`

---

### Phase 3: Уточняющие вопросы

**Цель**: Заполнить пробелы и разрешить неоднозначности ДО проектирования

**Действия**:
```yaml
1. Просмотреть находки:
   - Результаты исследования (Phase 2)
   - Исходные требования (Phase 1)

2. Выявить неоднозначности:
   - Граничные случаи
   - Обработка ошибок
   - Точки интеграции
   - Границы области
   - Предпочтения дизайна
   - Обратная совместимость
   - Производительность

3. Представить все вопросы пользователю:
   - Организованный список
   - С контекстом
   - С вариантами ответов

4. Ждать ответов перед проектированием

5. Сохранить:
   openspec/changes/[feature-name]/phase3-clarifications.md:
     - Список вопросов с контекстом
     - Ответы пользователя
     - Принятые решения
     - Рекомендации (если были)
```

**Важно**: Если пользователь говорит "как считаешь нужным" — предоставь рекомендацию и получи явное подтверждение.

**Артефакт**: `openspec/changes/[feature-name]/phase3-clarifications.md`

---

### Phase 4: Проектирование архитектуры

**Цель**: Спроектировать архитектуру реализации

**Адаптивный подход** (количество агентов зависит от сложности):

```yaml
Простая задача (1 агент):
  - Запустить 1 агента onec-code-architect
  - Создать практичный план

Средняя задача (1 агент + опционально 2):
  - По умолчанию: 1 агент
  - Если решение неочевидно: 2 агента с разными подходами

Сложная/критичная задача (2-3 агента, мультисэмплинг):
  - Запустить 2-3 агента onec-code-architect параллельно
  - Разные фокусы:
    * Минимальные изменения (переиспользование)
    * Чистая архитектура (поддерживаемость)
    * Прагматичный баланс (скорость + качество)
  - Представить все подходы пользователю
  - Спросить, какой подход предпочитает
```

**Действия**:
```yaml
1. Запустить агентов onec-code-architect:
   - Передать пути к артефактам (Phase 1, 2, 3)
   - Указать архитектурный подход
   - Запросить план с этапами

2. Для сложных задач (мультисэмплинг):
   - Сформировать мнение о лучшем подходе
   - Представить все подходы пользователю
   - Спросить предпочтение

3. Создать файл плана:
   openspec/changes/[feature-name]/phase4-architecture.md:
     - Постановка задачи
     - Оценка сложности (из Phase 0)
     - Выбранный подход с обоснованием
     - Найденные паттерны (из Phase 2)
     - Ответы на вопросы (из Phase 3)
     - ЭТАПЫ РЕАЛИЗАЦИИ (чеклист):
       * Гранулярность: простая=1, средняя=2-4, сложная=4-8, критичная=5-10+
       * Атомарность: этап за 1 сессию, проверяемый результат
       * Формат: - [ ] **Этап N**: описание + файлы + критерии + зависимости
     - Mermaid диаграммы (архитектура, потоки)
     - План самодостаточен для понимания
```

**Артефакт**: `openspec/changes/[feature-name]/phase4-architecture.md`

---

### Phase 5: Ревью плана

**Цель**: Валидировать план ДО реализации (ошибки в плане дороже ошибок в коде!)

**Действия**:
```yaml
1. Запустить агента onec-code-architect для ревью:
   - Передать пути к артефактам (Phase 1, 2, 3, 4)
   - Фокус ревью:
     * Полнота: все аспекты покрыты?
     * Корректность: соответствие паттернам из Phase 2?
     * Реалистичность: можно ли реализовать?
     * Соответствие требованиям: покрывает Phase 1 и Phase 3?
     * Критерии приемки: чёткие и проверяемые?
     * Зависимости: правильная последовательность?
     * Технический долг: усугубляет проблемы?

2. Если агент находит проблемы:
   - Обновить план (phase4-architecture.md)
   - Повторить Phase 5 (ревью обновлённого плана)

3. Когда план одобрен:
   - Сохранить результаты ревью:
     openspec/changes/[feature-name]/phase5-plan-review.md:
       * Что проверено
       * Найденные проблемы (если были)
       * Как исправлено (если были)
       * Итоговое заключение: план готов

4. Представить план пользователю:
   - Краткое резюме
   - Этапы реализации
   - Спросить явно: "План готов к реализации, можем начинать?"

НЕ ПЕРЕХОДИТЬ К PHASE 6 БЕЗ ЯВНОГО ОДОБРЕНИЯ!
```

**Артефакт**: `openspec/changes/[feature-name]/phase5-plan-review.md`

---

### Phase 6: Реализация по этапам

**Цель**: Построить доработку атомарными шагами с проверками

**НЕ НАЧИНАТЬ БЕЗ ОДОБРЕНИЯ ПОЛЬЗОВАТЕЛЯ!**

**Действия**:
```yaml
1. Прочитать план:
   openspec/changes/[feature-name]/phase4-architecture.md

2. Для каждого этапа последовательно:
   
   a. Отметить этап как начатый:
      - [ ] → - [🔄] в phase4-architecture.md
   
   b. Запустить агента onec-code-writer:
      - Передать путь к плану
      - Указать конкретный этап
      - Напомнить критерии приемки
   
   c. Проверить критерии приемки:
      - Все файлы созданы/изменены?
      - Критерии выполнены?
      - Код соответствует 1c-coding-standards.mdc?
      - BSL LSP диагностика чиста?
   
   d. Если критерии НЕ выполнены:
      - Запустить onec-code-writer для исправления
      - Описать проблемы
      - Повторить проверку
      - Цикл до выполнения критериев
   
   e. Отметить этап как завершённый:
      - [🔄] → - [x] в phase4-architecture.md

3. После всех этапов:
   - Проверить BSL LSP на всех файлах
   - Убедиться, что все критерии выполнены
```

**Артефакт**: Код + обновлённый `phase4-architecture.md` (с отметками)

---

### Phase 7: Ревью кода

**Цель**: Убедиться, что код корректен и соответствует плану

**Адаптивный подход** (количество ревьюеров зависит от размера):

```yaml
Простая задача (1 ревьюер):
  - onec-code-reviewer
  - Фокус: Базовая корректность + беглая проверка плана

Средняя/сложная задача (2 ревьюера):
  - onec-code-architect: Соответствие плану
  - onec-code-reviewer: Качество кода

Очень большая задача (раздельное ревью):
  - Разделить по модулям/подсистемам
  - Для каждого: architect + reviewer
```

**Действия**:
```yaml
1. Запустить ревьюеров:
   
   onec-code-architect (для средних/сложных):
     - Передать пути: phase1, phase4, phase5
     - Фокус: Соответствие плану, архитектуре, критериям
   
   onec-code-reviewer:
     - Указать путь к 1c-coding-standards.mdc
     - Фокус: Баги, читаемость, БСП, производительность, безопасность

2. Консолидировать ответы:
   - Выявить проблемы
   - Приоритизировать (critical, high, medium, low)

3. Сохранить результаты:
   openspec/changes/[feature-name]/phase7-code-review.md:
     - Что проверено
     - Найденные проблемы (severity + рекомендации)
     - Итоговая оценка

4. Представить пользователю:
   - Список проблем
   - Спросить, что делать:
     * Исправить сейчас
     * Исправить позже (TODO)
     * Продолжить как есть

5. Если "исправить сейчас":
   - Добавить в план секцию "Исправления после ревью"
   - Запустить onec-code-writer для исправления
   - Вернуться к началу Phase 7 (повторное ревью)
   - Итерации до качества

6. Если "исправить позже":
   - Добавить в план секцию "Технический долг"
   - Отметить как отложенные
```

**Артефакт**: `openspec/changes/[feature-name]/phase7-code-review.md`

---

### Phase 8: Итоги

**Цель**: Документировать выполненное

**Действия**:
```yaml
1. Отметить все задачи как завершённые

2. Создать резюме:
   openspec/changes/[feature-name]/phase8-summary.md:
     - Что построено (ссылки на этапы)
     - Ключевые решения (ссылка на план)
     - Изменённые файлы (git diff --stat)
     - Технический долг (если есть)
     - Предлагаемые следующие шаги

3. Представить пользователю:
   - Краткое резюме
   - Ссылки на артефакты
   - Следующие шаги (если есть)

4. Сохранить в RLM:
   rlm_add_hierarchical_fact(
     content="Завершена доработка [name]. Этапы: X, Файлы: Y, Качество: Z",
     level=1,
     domain="1c-development"
   )
   
   rlm_record_causal_decision(
     decision="Выбран подход X для доработки [name]",
     reasons=[...],
     consequences=[...]
   )
   
   rlm_sync_state()
```

**Артефакт**: `openspec/changes/[feature-name]/phase8-summary.md`

---

## АРТЕФАКТЫ

Все артефакты хранятся в `openspec/changes/[feature-name]/`:

```
openspec/changes/[feature-name]/
├── phase0-complexity.md      # Оценка сложности
├── phase1-requirements.md    # Требования
├── phase2-exploration.md     # Исследование кода
├── phase3-clarifications.md  # Уточнения
├── phase4-architecture.md    # План (с этапами)
├── phase5-plan-review.md     # Ревью плана
├── phase7-code-review.md     # Ревью кода
└── phase8-summary.md         # Итоги
```

**Phase 6** не создаёт отдельный файл, а обновляет `phase4-architecture.md` (отметки этапов).

---

## ИНТЕГРАЦИЯ С ИНСТРУМЕНТАМИ

### RLM-Toolkit

```yaml
Использование:
  - Phase 0: Загрузить контекст о проекте
  - Phase 2: Загрузить паттерны из прошлых доработок
  - Phase 4: Загрузить прошлые архитектурные решения
  - Phase 8: Сохранить результаты и решения

Команды:
  rlm_enterprise_context(query="доработка [name]")
  rlm_route_context(query="паттерны для [feature]")
  rlm_add_hierarchical_fact(content, level, domain)
  rlm_record_causal_decision(decision, reasons, consequences)
  rlm_sync_state()
```

### BSL LSP Bridge

```yaml
Использование:
  - Phase 6: Диагностика кода после написания
  - Phase 7: Проверка качества кода

Команды:
  bsl_lsp_diagnostics(file_path)
  bsl_lsp_format(file_path)
  bsl_lsp_symbols(file_path)
```

### MCP Серверы

```yaml
Использование:
  - Phase 2: Поиск метаданных и кода
  - Phase 6: Проверка синтаксиса и логики

Команды:
  user-PROJECT-codemetadata-metadatasearch (project-specific MCP)(query)
  user-PROJECT-codemetadata (project-specific MCP)-codesearch(query)
  user-1c-syntax-checker-syntaxcheck(code)
  user-1c-code-checker-check_1c_code(code, check_type)
```

---

## КРИТИЧЕСКИЕ ПРАВИЛА

1. ✅ **Phase 0 обязательна** - оценка сложности определяет стратегию
2. ✅ **Phase 3 обязательна** - уточнения ДО проектирования
3. ✅ **Phase 5 обязательна** - ревью плана ДО реализации
4. ✅ **Одобрение пользователя** - перед Phase 6
5. ✅ **Атомарные этапы** - каждый с критериями приемки
6. ✅ **Итеративное ревью** - Phase 7 повторяется до качества
7. ✅ **Адаптивность** - количество агентов зависит от сложности
8. ✅ **Артефакты в openspec/** - не в .tasks/
9. ✅ **Сохранение в RLM** - Phase 8 обязательна
10. ✅ **Следование стандартам** - 1c-coding-standards.mdc

---

## ПРИМЕРЫ

### Пример 1: Простая задача

```yaml
Задача: Добавить поле "Email" в справочник Клиенты

Phase 0:
  Оценка: Простая
  Стратегия: 1 explorer, 1 architect, 1 writer

Phase 1:
  Требования: Добавить поле Email (строка 100)

Phase 2:
  1 агент explorer: Нашёл паттерны добавления реквизитов

Phase 3:
  Вопросы: Валидация email? Обязательность?
  Ответы: Да, валидация. Не обязательное.

Phase 4:
  1 агент architect: План с 1 этапом

Phase 5:
  Ревью: План корректен

Phase 6:
  Этап 1: Добавить реквизит + валидацию

Phase 7:
  1 ревьюер: Код корректен

Phase 8:
  Резюме: Добавлено поле Email с валидацией
```

### Пример 2: Сложная задача

```yaml
Задача: Интеграция с внешней системой складского учёта

Phase 0:
  Оценка: Сложная
  Стратегия: 3 explorer, 2 architect (мультисэмплинг), 1 writer

Phase 1:
  Требования: Синхронизация остатков, обмен документами

Phase 2:
  3 агента explorer (параллельно):
    - Агент 1: Существующие интеграции
    - Агент 2: Архитектура обмена данными
    - Агент 3: Обработка ошибок и логирование

Phase 3:
  Вопросы: Формат обмена? Частота? Конфликты?
  Ответы: JSON, каждые 5 мин, приоритет внешней системе

Phase 4:
  2 агента architect (мультисэмплинг):
    - Агент 1: Минимальные изменения (адаптер к существующему)
    - Агент 2: Чистая архитектура (новый слой интеграции)
  Выбор: Чистая архитектура (долгосрочная поддержка)
  План: 6 этапов

Phase 5:
  Ревью: Найдены проблемы с обработкой ошибок
  Обновление: Добавлен retry mechanism
  Повторное ревью: План одобрен

Phase 6:
  Этапы 1-6: Реализация с проверками

Phase 7:
  2 ревьюера:
    - architect: Соответствие плану - OK
    - reviewer: Найдены 2 проблемы (high priority)
  Исправление: Оптимизация запросов
  Повторное ревью: Код одобрен

Phase 8:
  Резюме: Интеграция готова, 6 этапов, 15 файлов
```

---

**Последнее обновление**: 2026-02-08  
**Версия**: 2.0  
**Источник**: AndreevED/1c-ai-feature-dev-workflow + улучшения (RLM, BSL LSP, openspec/)
