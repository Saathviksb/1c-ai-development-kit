---
name: 1c-feature-dev-enhanced
description: Complete 1C feature development cycle - from analysis to implementation with БСП compliance. Use when user requests "создать доработку 1C", "реализовать функционал 1C", "добавить новую возможность в 1C", "разработать модуль 1C", or needs full development cycle from analysis to implementation with validation.
---

# 1C Feature Development (Enhanced)

Полный цикл разработки доработок 1С с использованием спецификаций, адаптивного подхода и интеграции с инструментами (RLM, BSL LSP, MCP).

---

## ПРИНЦИПЫ РАБОТЫ

- **Адаптивность**: Количество агентов зависит от сложности (1-4+)
- **Ранняя валидация**: Ревью плана ДО реализации
- **Уточнение требований**: Все неоднозначности разрешаются ДО проектирования
- **Атомарные этапы**: С критериями приемки и проверками
- **Отслеживание прогресса**: Каждая фаза отмечается как завершённая

---

## WORKFLOW (9 ФАЗ)

### Phase 0: Оценка сложности

**Цель**: Понять масштаб задачи и выбрать стратегию

**Начальный запрос**: $ARGUMENTS

**Действия**:
1. Создать список задач со всеми фазами
2. Создать структуру: `openspec/changes/[feature-name]/`
3. Оценить сложность:
   - **Простая**: Небольшое изменение, очевидная реализация
   - **Средняя**: Несколько модулей, требует понимания архитектуры
   - **Сложная**: Большая доработка, несколько подсистем
   - **Критичная**: Архитектурные изменения, высокие риски
4. Выбрать стратегию (количество агентов)
5. Сохранить: `openspec/changes/[feature-name]/phase0-complexity.md`

**Артефакт**: `phase0-complexity.md`

---

### Phase 1: Discovery

**Цель**: Понять, что нужно построить

**Действия**:
1. Если доработка неясна - задать вопросы:
   - Какую проблему решаем?
   - Что должна делать доработка?
   - Есть ли ограничения?
2. Резюмировать понимание
3. Получить подтверждение пользователя
4. Сохранить: `openspec/changes/[feature-name]/phase1-requirements.md`

**Артефакт**: `phase1-requirements.md`

---

### Phase 2: Исследование кодовой базы

**Цель**: Понять существующий код и паттерны

**Адаптивный подход**:
- **Простая**: 1 агент `onec-code-explorer`
- **Средняя**: 1-2 агента (возможно последовательно)
- **Сложная**: 2-4 агента (параллельно или последовательно)
- **Критичная**: 4+ агентов (итеративное углубление)

**Действия**:
1. Принять решение о стратегии
2. Запустить агентов `onec-code-explorer`:
   ```
   Task(
     description="Исследовать код [feature]",
     prompt="Проанализируй существующий код для [feature].
            Найди паттерны, архитектуру, похожие доработки.
            Верни список ключевых файлов для чтения.
            
            Требования: openspec/changes/[feature]/phase1-requirements.md",
     subagent_type="generalPurpose",
     model="fast"
   )
   ```
3. Прочитать все указанные файлы
4. Оценить достаточность (запустить ещё агентов если нужно)
5. Сохранить сводку: `openspec/changes/[feature-name]/phase2-exploration.md`

**Артефакт**: `phase2-exploration.md`

---

### Phase 3: Уточняющие вопросы

**Цель**: Заполнить пробелы ДО проектирования

**Действия**:
1. Просмотреть находки (Phase 2) и требования (Phase 1)
2. Выявить неоднозначности:
   - Граничные случаи
   - Обработка ошибок
   - Точки интеграции
   - Производительность
3. Представить ВСЕ вопросы пользователю (организованный список)
4. **Ждать ответов перед Phase 4**
5. Сохранить: `openspec/changes/[feature-name]/phase3-clarifications.md`

**Важно**: Если "как считаешь нужным" - дать рекомендацию и получить подтверждение

**Артефакт**: `phase3-clarifications.md`

---

### Phase 4: Проектирование архитектуры

**Цель**: Спроектировать архитектуру реализации

**Адаптивный подход**:
- **Простая**: 1 агент `onec-code-architect`
- **Средняя**: 1 агент (опционально 2 с разными подходами)
- **Сложная/критичная**: 2-3 агента (мультисэмплинг):
  * Минимальные изменения
  * Чистая архитектура
  * Прагматичный баланс

**Действия**:
1. Запустить агентов `onec-code-architect`:
   ```
   Task(
     description="Спроектировать архитектуру [feature]",
     prompt="Спроектируй архитектуру для [feature].
            
            Артефакты:
            - phase1-requirements.md
            - phase2-exploration.md
            - phase3-clarifications.md
            
            Подход: [минимальные изменения / чистая архитектура / баланс]
            
            Создай план с этапами реализации (атомарные, с критериями приемки).
            Используй Mermaid диаграммы для визуализации.",
     subagent_type="generalPurpose"
   )
   ```
2. Для сложных задач: представить все подходы, спросить предпочтение
3. Создать файл: `openspec/changes/[feature-name]/phase4-architecture.md`
   - Постановка задачи
   - Оценка сложности
   - Выбранный подход
   - Найденные паттерны
   - Ответы на вопросы
   - **ЭТАПЫ РЕАЛИЗАЦИИ** (чеклист markdown)
   - Mermaid диаграммы

**Артефакт**: `phase4-architecture.md`

---

### Phase 5: Ревью плана

**Цель**: Валидировать план ДО реализации

**Действия**:
1. Запустить агента `onec-code-architect` для ревью:
   ```
   Task(
     description="Ревью плана [feature]",
     prompt="Проверь архитектурный план для [feature].
            
            Артефакты:
            - phase1-requirements.md
            - phase2-exploration.md
            - phase3-clarifications.md
            - phase4-architecture.md
            
            Фокус:
            - Полнота (все аспекты покрыты?)
            - Корректность (соответствие паттернам?)
            - Реалистичность (можно реализовать?)
            - Соответствие требованиям
            - Критерии приемки (чёткие?)
            - Зависимости (правильная последовательность?)
            
            Если проблемы - опиши и предложи исправления.",
     subagent_type="generalPurpose"
   )
   ```
2. Если проблемы найдены:
   - Обновить план (phase4-architecture.md)
   - Повторить Phase 5
3. Когда одобрен:
   - Сохранить: `openspec/changes/[feature-name]/phase5-plan-review.md`
4. Представить план пользователю
5. **Спросить явно**: "План готов к реализации, можем начинать?"

**НЕ ПЕРЕХОДИТЬ К PHASE 6 БЕЗ ОДОБРЕНИЯ!**

**Артефакт**: `phase5-plan-review.md`

---

### Phase 6: Реализация по этапам

**Цель**: Построить доработку атомарными шагами

**НЕ НАЧИНАТЬ БЕЗ ОДОБРЕНИЯ!**

**Действия**:
1. Прочитать план: `openspec/changes/[feature-name]/phase4-architecture.md`
2. Для каждого этапа последовательно:
   
   a. Отметить как начатый: `- [ ]` → `- [🔄]` в phase4-architecture.md
   
   b. Запустить агента `onec-code-writer`:
      ```
      Task(
        description="Реализовать этап N [feature]",
        prompt="Реализуй этап N для [feature].
               
               План: openspec/changes/[feature]/phase4-architecture.md
               Этап: [номер и описание]
               
               Критерии приемки:
               - [список критериев из плана]
               
               Следуй 1c-coding-standards.mdc.
               Используй BSL LSP для проверки.
               Проведи самоконтроль.",
        subagent_type="generalPurpose",
        model="fast"
      )
      ```
   
   c. Проверить критерии приемки:
      - Все файлы созданы/изменены?
      - Критерии выполнены?
      - Код соответствует стандартам?
      - BSL LSP диагностика чиста?
   
   d. Если НЕ выполнены:
      - Запустить `onec-code-writer` для исправления
      - Повторить проверку
      - Цикл до выполнения
   
   e. Отметить как завершённый: `- [🔄]` → `- [x]` в phase4-architecture.md

3. После всех этапов:
   - Проверить BSL LSP на всех файлах
   - Убедиться, что все критерии выполнены

**Артефакт**: Код + обновлённый `phase4-architecture.md`

---

### Phase 7: Ревью кода

**Цель**: Убедиться, что код корректен и соответствует плану

**Адаптивный подход**:
- **Простая**: 1 ревьюер (`onec-code-reviewer`)
- **Средняя/сложная**: 2 ревьюера (`onec-code-architect` + `onec-code-reviewer`)
- **Очень большая**: Раздельное ревью по модулям

**Действия**:
1. Запустить ревьюеров:
   
   **onec-code-architect** (для средних/сложных):
   ```
   Task(
     description="Ревью соответствия плану [feature]",
     prompt="Проверь соответствие кода архитектурному плану.
            
            Артефакты:
            - phase1-requirements.md
            - phase4-architecture.md
            - phase5-plan-review.md
            
            Фокус:
            - Соответствие плану
            - Соответствие архитектурным решениям
            - Выполнение критериев приемки этапов",
     subagent_type="generalPurpose"
   )
   ```
   
   **onec-code-reviewer**:
   ```
   Task(
     description="Ревью качества кода [feature]",
     prompt="Проверь качество кода для [feature].
            
            Стандарты: 1c-coding-standards.mdc
            
            Фокус:
            - Баги
            - Читаемость
            - БСП compliance
            - Производительность
            - Безопасность
            
            Используй BSL LSP для диагностики.",
     subagent_type="generalPurpose",
     model="fast"
   )
   ```

2. Консолидировать ответы, выявить проблемы
3. Сохранить: `openspec/changes/[feature-name]/phase7-code-review.md`
4. Представить пользователю, спросить:
   - Исправить сейчас?
   - Исправить позже (TODO)?
   - Продолжить как есть?
5. Если "исправить сейчас":
   - Добавить в план секцию "Исправления после ревью"
   - Запустить `onec-code-writer`
   - Вернуться к началу Phase 7
   - Итерации до качества
6. Если "исправить позже":
   - Добавить в план секцию "Технический долг"

**Артефакт**: `phase7-code-review.md`

---

### Phase 8: Итоги

**Цель**: Документировать выполненное

**Действия**:
1. Отметить все задачи как завершённые
2. Создать резюме: `openspec/changes/[feature-name]/phase8-summary.md`
   - Что построено
   - Ключевые решения
   - Изменённые файлы (git diff --stat)
   - Технический долг (если есть)
   - Следующие шаги
3. Представить пользователю
4. Сохранить в RLM (если доступен):
   ```
   rlm_add_hierarchical_fact(
     content="Завершена доработка [name]. Этапы: X, Файлы: Y",
     level=1,
     domain="1c-development"
   )
   
   rlm_record_causal_decision(
     decision="Выбран подход X для [name]",
     reasons=[...],
     consequences=[...]
   )
   
   rlm_sync_state()
   ```

**Артефакт**: `phase8-summary.md`

---

## АРТЕФАКТЫ

Все артефакты в `openspec/changes/[feature-name]/`:

```
openspec/changes/[feature-name]/
├── phase0-complexity.md      # Оценка сложности
├── phase1-requirements.md    # Требования
├── phase2-exploration.md     # Исследование кода
├── phase3-clarifications.md  # Уточнения
├── phase4-architecture.md    # План (с этапами)
├── phase5-plan-review.md     # Ревью плана
├── phase7-code-review.md     # Ревью кода
└── phase8-summary.md         # Итоги
```

Phase 6 обновляет `phase4-architecture.md` (отметки этапов).

---

## ИНТЕГРАЦИЯ С ИНСТРУМЕНТАМИ

### RLM-Toolkit (если доступен)

```yaml
Phase 0: rlm_enterprise_context(query="доработка [name]")
Phase 2: rlm_route_context(query="паттерны для [feature]")
Phase 4: rlm_route_context(query="архитектурные решения")
Phase 8: 
  - rlm_add_hierarchical_fact(...)
  - rlm_record_causal_decision(...)
  - rlm_sync_state()
```

### BSL LSP Bridge

```yaml
Phase 6: bsl_lsp_diagnostics(file_path) после написания кода
Phase 7: bsl_lsp_diagnostics(file_path) для проверки качества
```

### MCP Серверы

```yaml
Phase 2: 
  - user-PROJECT-codemetadata-metadatasearch (project-specific MCP)(query)
  - user-PROJECT-codemetadata (project-specific MCP)-codesearch(query)

Phase 6:
  - user-1c-syntax-checker-syntaxcheck(code)
  - user-1c-code-checker-check_1c_code(code, check_type)
```

---

## КРИТИЧЕСКИЕ ПРАВИЛА

1. ✅ **Phase 0 обязательна** - оценка определяет стратегию
2. ✅ **Phase 3 обязательна** - уточнения ДО проектирования
3. ✅ **Phase 5 обязательна** - ревью плана ДО реализации
4. ✅ **Одобрение пользователя** - перед Phase 6
5. ✅ **Атомарные этапы** - каждый с критериями приемки
6. ✅ **Итеративное ревью** - Phase 7 повторяется до качества
7. ✅ **Адаптивность** - количество агентов зависит от сложности
8. ✅ **Артефакты в openspec/** - не в .tasks/
9. ✅ **Сохранение в RLM** - Phase 8 обязательна (если доступен)
10. ✅ **Следование стандартам** - 1c-coding-standards.mdc

---

## ПРИМЕРЫ

### Пример 1: Простая задача

```yaml
Задача: Добавить поле "Email" в справочник Клиенты

Phase 0:
  Оценка: Простая
  Стратегия: 1 explorer, 1 architect, 1 writer

Phase 1:
  Требования: Добавить поле Email (строка 100), валидация

Phase 2:
  1 агент explorer: Нашёл паттерны добавления реквизитов

Phase 3:
  Вопросы: Обязательность? Формат валидации?
  Ответы: Не обязательное, простая проверка @

Phase 4:
  1 агент architect: План с 1 этапом

Phase 5:
  Ревью: План корректен, одобрен

Phase 6:
  Этап 1: Добавить реквизит + валидацию (выполнен)

Phase 7:
  1 ревьюер: Код корректен

Phase 8:
  Резюме: Добавлено поле Email с валидацией

Время: ~2 часа
Токены: ~15k
```

### Пример 2: Сложная задача

```yaml
Задача: Интеграция с внешней системой складского учёта

Phase 0:
  Оценка: Сложная
  Стратегия: 3 explorer, 2 architect (мультисэмплинг), 1 writer

Phase 1:
  Требования: Синхронизация остатков, обмен документами, JSON, каждые 5 мин

Phase 2:
  3 агента explorer (параллельно):
    - Агент 1: Существующие интеграции
    - Агент 2: Архитектура обмена данными
    - Агент 3: Обработка ошибок и логирование

Phase 3:
  Вопросы: Конфликты? Приоритеты? Retry?
  Ответы: Приоритет внешней системе, retry 3 раза

Phase 4:
  2 агента architect (мультисэмплинг):
    - Агент 1: Минимальные изменения (адаптер)
    - Агент 2: Чистая архитектура (новый слой)
  Выбор: Чистая архитектура
  План: 6 этапов

Phase 5:
  Ревью: Найдены проблемы с обработкой ошибок
  Обновление: Добавлен retry mechanism
  Повторное ревью: План одобрен

Phase 6:
  Этапы 1-6: Реализация с проверками (все выполнены)

Phase 7:
  2 ревьюера:
    - architect: Соответствие плану - OK
    - reviewer: Найдены 2 проблемы (high)
  Исправление: Оптимизация запросов
  Повторное ревью: Код одобрен

Phase 8:
  Резюме: Интеграция готова, 6 этапов, 15 файлов

Время: ~2 дня
Токены: ~150k
```

---

## КОМАНДЫ

### Запуск workflow

```
/1c-feature-dev Добавить интеграцию с API складской системы
```

или

```
Создай доработку: Добавить поле Email в справочник Клиенты
```

### Проработка идей

```
/brainstorm Хочу добавить систему уведомлений
```

---

## 🎯 ИНТЕГРАЦИЯ С НОВЫМИ SKILLS

### Phase 6: Использование специализированных skills

При реализации используй специализированные skills для типовых задач:

#### Создание форм
```yaml
Если в плане: "Создать форму"

Шаги:
  1. Загрузить: 1c-forms/SKILL.md
  2. Использовать workflow из 1c-forms:
     - patterns: Выбрать архетип
     - scaffold: Создать структуру
     - compile: Сгенерировать из JSON DSL
     - validate: Проверить корректность
```

#### Создание макетов (печатные формы)
```yaml
Если в плане: "Создать печатную форму"

Шаги:
  1. Загрузить: 1c-mxl/SKILL.md
  2. Использовать workflow из 1c-mxl:
     - Спроектировать структуру (JSON DSL)
     - compile: Сгенерировать Template.xml
     - validate: Проверить корректность
```

#### Настройка прав доступа
```yaml
Если в плане: "Настроить права" или "Создать роль"

Шаги:
  1. Загрузить: 1c-roles/SKILL.md
  2. Использовать workflow из 1c-roles:
     - Определить набор прав (JSON DSL)
     - compile: Создать Rights.xml
     - info: Проверить корректность
```

#### Интеграция с БСП
```yaml
Если в плане: "Интегрировать с БСП" или "Зарегистрировать обработку"

Шаги:
  1. Загрузить: 1c-bsp/SKILL.md
  2. Использовать workflow из 1c-bsp:
     - registration: Зарегистрировать в БСП
     - command: Добавить команды
     - patterns: Использовать готовые паттерны
```

#### Оптимизация запросов
```yaml
Если в плане: "Оптимизировать запрос" или проблемы с производительностью

Шаги:
  1. Загрузить: 1c-query-optimization/SKILL.md
  2. Применить паттерны оптимизации:
     - Временные таблицы
     - JOIN vs подзапросы
     - Параметры виртуальных таблиц
     - Индексирование
```

### Обновленный Phase 6 workflow

```yaml
Для каждого этапа:
  
  1. Определить тип задачи:
     - Создание формы → используй 1c-forms
     - Печатная форма → используй 1c-mxl
     - Настройка прав → используй 1c-roles
     - Интеграция БСП → используй 1c-bsp
     - Оптимизация → используй 1c-query-optimization
     - Общая задача → используй onec-code-writer
  
  2. Загрузить соответствующий skill
  
  3. Следовать workflow из skill
  
  4. Валидировать результат
  
  5. Отметить этап как завершенный
```

---

**Last updated**: 2026-02-11  
**Version**: 2.1  
**Source**: AndreevED/1c-ai-feature-dev-workflow + cursor_rules_1c skills + наши улучшения
